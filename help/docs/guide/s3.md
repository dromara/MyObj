# S3 åè®®ä½¿ç”¨

MyObj æä¾›å®Œæ•´çš„ AWS S3 å…¼å®¹ APIï¼Œå¯ä»¥ä½¿ç”¨ MinIO SDKã€AWS SDK æˆ–å…¶ä»– S3 å…¼å®¹å·¥å…·è¿›è¡Œè®¿é—®ã€‚

## ğŸ¯ æ¦‚è¿°

MyObj S3 æœåŠ¡å®Œå…¨å…¼å®¹ AWS S3 åè®®ï¼Œæ”¯æŒæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å’Œé«˜çº§ç‰¹æ€§ï¼ŒåŒ…æ‹¬ï¼š

- âœ… Bucket æ“ä½œï¼ˆåˆ›å»ºã€åˆ é™¤ã€åˆ—è¡¨ï¼‰
- âœ… Object æ“ä½œï¼ˆä¸Šä¼ ã€ä¸‹è½½ã€åˆ é™¤ã€åˆ—è¡¨ï¼‰
- âœ… Multipart Uploadï¼ˆå¤§æ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ ï¼‰
- âœ… ç‰ˆæœ¬æ§åˆ¶
- âœ… é¢„ç­¾å URL
- âœ… CORS é…ç½®
- âœ… å¯¹è±¡æ ‡ç­¾
- âœ… ACLï¼ˆè®¿é—®æ§åˆ¶åˆ—è¡¨ï¼‰
- âœ… Bucket ç­–ç•¥
- âœ… ç”Ÿå‘½å‘¨æœŸç®¡ç†
- âœ… æœåŠ¡ç«¯åŠ å¯†ï¼ˆSSE-S3ï¼‰

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å¯ç”¨ S3 æœåŠ¡

ç¼–è¾‘ `config.toml`:

```toml
[s3]
# æ˜¯å¦å¯ç”¨ S3 æœåŠ¡
enable = true
# åŒºåŸŸåç§°
region = "us-east-1"
# æ˜¯å¦ä¸ä¸»æœåŠ¡å…±ç”¨ç«¯å£ï¼ˆtrue: å…±ç”¨ 8080ï¼Œfalse: ä½¿ç”¨ç‹¬ç«‹ç«¯å£ï¼‰
share_port = false
# ç‹¬ç«‹ç«¯å£ï¼ˆå½“ share_port = false æ—¶ç”Ÿæ•ˆï¼‰
port = 9000
# S3 API è·¯å¾„å‰ç¼€ï¼ˆç•™ç©ºè¡¨ç¤ºæ ¹è·¯å¾„ /ï¼‰
path_prefix = ""
```

### 2. åˆ›å»º API Key

S3 è®¿é—®éœ€è¦ä½¿ç”¨ API Key ä½œä¸ºå‡­è¯ï¼š

1. ç™»å½• Web ç•Œé¢
2. è¿›å…¥"è®¾ç½®" â†’ "API Key"
3. åˆ›å»ºæ–°çš„ API Key
4. ä¿å­˜ Access Key ID å’Œ Secret Access Key

### 3. ä½¿ç”¨ SDK

#### Go è¯­è¨€ - MinIO SDK

```go
package main

import (
    "context"
    "log"
    
    "github.com/minio/minio-go/v7"
    "github.com/minio/minio-go/v7/pkg/credentials"
)

func main() {
    // åˆå§‹åŒ–å®¢æˆ·ç«¯
    client, err := minio.New("localhost:9000", &minio.Options{
        Creds:  credentials.NewStaticV4("your-access-key-id", "your-secret-key", ""),
        Secure: false,
        Region: "us-east-1",
    })
    if err != nil {
        log.Fatal(err)
    }
    
    ctx := context.Background()
    
    // åˆ—å‡ºæ‰€æœ‰ Bucket
    buckets, err := client.ListBuckets(ctx)
    if err != nil {
        log.Fatal(err)
    }
    
    for _, bucket := range buckets {
        log.Printf("Bucket: %s, Created: %v\n", bucket.Name, bucket.CreationDate)
    }
    
    // åˆ›å»º Bucket
    err = client.MakeBucket(ctx, "my-bucket", minio.MakeBucketOptions{
        Region: "us-east-1",
    })
    if err != nil {
        log.Fatal(err)
    }
    
    log.Println("Bucket created successfully")
}
```

#### Java è¯­è¨€ - AWS SDK

**Maven ä¾èµ–**ï¼š

```xml
<dependency>
    <groupId>software.amazon.awssdk</groupId>
    <artifactId>s3</artifactId>
</dependency>
<dependency>
    <groupId>software.amazon.awssdk</groupId>
    <artifactId>netty-nio-client</artifactId>
</dependency>
```

**Java ä»£ç ç¤ºä¾‹**ï¼š

```java
import software.amazon.awssdk.auth.credentials.AwsBasicCredentials;
import software.amazon.awssdk.auth.credentials.StaticCredentialsProvider;
import software.amazon.awssdk.regions.Region;
import software.amazon.awssdk.services.s3.S3Client;
import software.amazon.awssdk.services.s3.model.*;

import java.net.URI;

public class S3Example {
    public static void main(String[] args) {
        // åˆ›å»º S3 å®¢æˆ·ç«¯
        S3Client s3Client = S3Client.builder()
            .endpointOverride(URI.create("http://localhost:9000"))
            .credentialsProvider(StaticCredentialsProvider.create(
                AwsBasicCredentials.create("your-access-key-id", "your-secret-key")
            ))
            .region(Region.US_EAST_1)
            .forcePathStyle(true)  // é‡è¦ï¼šä½¿ç”¨è·¯å¾„é£æ ¼
            .build();
        
        // MyObj æ”¯æŒè‡ªåŠ¨åˆ›å»ºå­˜å‚¨æ¡¶ï¼Œé¦–æ¬¡ä¸Šä¼ æ—¶ä¼šè‡ªåŠ¨åˆ›å»º
        // ä¸Šä¼ å¯¹è±¡ï¼ˆå¦‚æœ Bucket ä¸å­˜åœ¨ä¼šè‡ªåŠ¨åˆ›å»ºï¼‰
        PutObjectRequest putObjectRequest = PutObjectRequest.builder()
            .bucket("my-bucket")  // Bucket ä¼šè‡ªåŠ¨åˆ›å»º
            .key("object-key")
            .contentType("text/plain")
            .acl(ObjectCannedACL.PRIVATE)  // è®¾ç½® ACLï¼šç§æœ‰
            .build();
        s3Client.putObject(putObjectRequest, 
            software.amazon.awssdk.core.sync.RequestBody.fromString("Hello MyObj"));
        
        // ä¸‹è½½å¯¹è±¡
        GetObjectRequest getObjectRequest = GetObjectRequest.builder()
            .bucket("my-bucket")
            .key("object-key")
            .build();
        String content = s3Client.getObjectAsBytes(getObjectRequest)
            .asUtf8String();
        System.out.println("Content: " + content);
        
        s3Client.close();
    }
}
```

**ACL é…ç½®è¯´æ˜**ï¼š

MyObj S3 æ”¯æŒæ ‡å‡†çš„ S3 Canned ACLï¼Œä¸Šä¼ å¯¹è±¡æ—¶å¯ä»¥è®¾ç½®ï¼š

```java
// ç§æœ‰è®¿é—®ï¼ˆé»˜è®¤ï¼‰
.acl(ObjectCannedACL.PRIVATE)

// å…¬å¼€è¯»
.acl(ObjectCannedACL.PUBLIC_READ)

// å…¬å¼€è¯»å†™
.acl(ObjectCannedACL.PUBLIC_READ_WRITE)

// è®¤è¯ç”¨æˆ·è¯»
.acl(ObjectCannedACL.AUTHENTICATED_READ)

// Bucket æ‰€æœ‰è€…è¯»
.acl(ObjectCannedACL.BUCKET_OWNER_READ)

// Bucket æ‰€æœ‰è€…å®Œå…¨æ§åˆ¶
.acl(ObjectCannedACL.BUCKET_OWNER_FULL_CONTROL)
```

**æ”¯æŒçš„ ACL ç±»å‹**ï¼š
- `PRIVATE` - ç§æœ‰è®¿é—®ï¼Œä»…æ‰€æœ‰è€…å¯è®¿é—®
- `PUBLIC_READ` - å…¬å¼€è¯»ï¼Œæ‰€æœ‰äººå¯è¯»å–
- `PUBLIC_READ_WRITE` - å…¬å¼€è¯»å†™ï¼Œæ‰€æœ‰äººå¯è¯»å–å’Œå†™å…¥
- `AUTHENTICATED_READ` - è®¤è¯ç”¨æˆ·è¯»ï¼Œæ‰€æœ‰è®¤è¯ç”¨æˆ·å¯è¯»å–
- `BUCKET_OWNER_READ` - Bucket æ‰€æœ‰è€…è¯»
- `BUCKET_OWNER_FULL_CONTROL` - Bucket æ‰€æœ‰è€…å®Œå…¨æ§åˆ¶

**æ³¨æ„**ï¼šMyObj æ”¯æŒè‡ªåŠ¨åˆ›å»ºå­˜å‚¨æ¡¶ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒç”¨ `createBucket()`ã€‚

## ğŸ“‹ åŠŸèƒ½è¯¦è§£

### Bucket æ“ä½œ

#### åˆ›å»º Bucket

```go
err := client.MakeBucket(ctx, "my-bucket", minio.MakeBucketOptions{
    Region: "us-east-1",
})
```

#### åˆ—å‡º Bucket

```go
buckets, err := client.ListBuckets(ctx)
```

#### åˆ é™¤ Bucket

```go
err := client.RemoveBucket(ctx, "my-bucket")
```

### Object æ“ä½œ

#### ä¸Šä¼ å¯¹è±¡

**Go è¯­è¨€**ï¼š

```go
info, err := client.FPutObject(ctx, "my-bucket", "object-key", "local-file.pdf", minio.PutObjectOptions{
    ContentType: "application/pdf",
})
```

**Java è¯­è¨€**ï¼š

```java
PutObjectRequest putObjectRequest = PutObjectRequest.builder()
    .bucket("my-bucket")
    .key("object-key")
    .contentType("application/pdf")
    .acl(ObjectCannedACL.PRIVATE)  // è®¾ç½® ACL
    .build();
s3Client.putObject(putObjectRequest, RequestBody.fromFile(new File("local-file.pdf")));
```

#### ä¸‹è½½å¯¹è±¡

```go
err := client.FGetObject(ctx, "my-bucket", "object-key", "local-file.pdf", minio.GetObjectOptions{})
```

#### åˆ—å‡ºå¯¹è±¡

```go
objectCh := client.ListObjects(ctx, "my-bucket", minio.ListObjectsOptions{
    Prefix:    "folder/",
    Recursive: true,
})
for object := range objectCh {
    log.Printf("Object: %s, Size: %d\n", object.Key, object.Size)
}
```

### Multipart Upload

å¯¹äºå¤§æ–‡ä»¶ï¼Œä½¿ç”¨åˆ†ç‰‡ä¸Šä¼ ï¼š

```go
// åˆå§‹åŒ–åˆ†ç‰‡ä¸Šä¼ 
uploadID, err := client.NewMultipartUpload(ctx, "my-bucket", "large-file.zip", minio.PutObjectOptions{})

// ä¸Šä¼ åˆ†ç‰‡
part1, err := client.PutObjectPart(ctx, "my-bucket", "large-file.zip", uploadID, 1, file1, -1, minio.PutObjectPartOptions{})
part2, err := client.PutObjectPart(ctx, "my-bucket", "large-file.zip", uploadID, 2, file2, -1, minio.PutObjectPartOptions{})

// å®Œæˆåˆ†ç‰‡ä¸Šä¼ 
parts := []minio.CompletePart{part1, part2}
_, err = client.CompleteMultipartUpload(ctx, "my-bucket", "large-file.zip", uploadID, parts, minio.PutObjectPartOptions{})
```

### ç‰ˆæœ¬æ§åˆ¶

#### å¯ç”¨ç‰ˆæœ¬æ§åˆ¶

```go
err := client.SetBucketVersioning(ctx, "my-bucket", minio.BucketVersioningConfiguration{
    Status: "Enabled",
})
```

#### åˆ—å‡ºå¯¹è±¡ç‰ˆæœ¬

```go
objectCh := client.ListObjects(ctx, "my-bucket", minio.ListObjectsOptions{
    WithVersions: true,
})
```

### é¢„ç­¾å URL

ç”Ÿæˆé¢„ç­¾å URLï¼Œå…è®¸ä¸´æ—¶è®¿é—®ï¼š

```go
// GET é¢„ç­¾å URLï¼ˆä¸‹è½½ï¼‰
url, err := client.PresignedGetObject(ctx, "my-bucket", "object-key", time.Hour*24, nil)

// PUT é¢„ç­¾å URLï¼ˆä¸Šä¼ ï¼‰
url, err := client.PresignedPutObject(ctx, "my-bucket", "object-key", time.Hour*24)
```

### CORS é…ç½®

```go
corsConfig := minio.BucketCors{
    CORSRules: []minio.CORSRule{
        {
            AllowedOrigins: []string{"*"},
            AllowedMethods: []string{"GET", "PUT", "POST", "DELETE"},
            AllowedHeaders: []string{"*"},
            MaxAgeSeconds:  3600,
        },
    },
}
err := client.SetBucketCors(ctx, "my-bucket", &corsConfig)
```

## ğŸ”§ é…ç½®è¯´æ˜

### Bucket å‘½åè§„èŒƒ

ç¬¦åˆ AWS S3 Bucket å‘½åè§„èŒƒï¼š
- é•¿åº¦åœ¨ 3-63 ä¸ªå­—ç¬¦ä¹‹é—´
- åªèƒ½åŒ…å«å°å†™å­—æ¯ã€æ•°å­—ã€ç‚¹(.)å’Œè¿å­—ç¬¦(-)
- å¿…é¡»ä»¥å­—æ¯æˆ–æ•°å­—å¼€å¤´å’Œç»“å°¾
- ä¸èƒ½åŒ…å«è¿ç»­çš„ç‚¹
- ä¸èƒ½æ˜¯ IP åœ°å€æ ¼å¼

### è®¤è¯æ–¹å¼

ä½¿ç”¨ AWS Signature V4 ç­¾åæœºåˆ¶ï¼š
- **Access Key ID**: å¯¹åº” MyObj çš„ API Key
- **Secret Access Key**: å¯¹åº” API Key çš„ç§é’¥
- ç­¾åè®¡ç®—æ–¹å¼ä¸ AWS S3 å®Œå…¨å…¼å®¹

### Bucket æ˜ å°„

- æ¯ä¸ª Bucket å¯¹åº”ä¸€ä¸ªç”¨æˆ·è™šæ‹Ÿç›®å½•
- ä¸€ä¸ªç”¨æˆ·å¯ä»¥åˆ›å»ºå¤šä¸ª Bucket
- Bucket åç§°åœ¨ç”¨æˆ·ç©ºé—´å†…å¿…é¡»å”¯ä¸€

### è‡ªåŠ¨åˆ›å»ºå­˜å‚¨æ¡¶

MyObj S3 æ”¯æŒè‡ªåŠ¨åˆ›å»ºå­˜å‚¨æ¡¶ï¼š
- é¦–æ¬¡ä½¿ç”¨æ—¶ä¼šè‡ªåŠ¨åˆ›å»ºé…ç½®çš„ Bucket
- æ— éœ€æ‰‹åŠ¨åˆ›å»ºï¼Œç®€åŒ–é…ç½®æµç¨‹
- è‡ªåŠ¨å¤„ç† Bucket å‘½åå’Œæƒé™è®¾ç½®

## ğŸ“Š ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1: å¤‡ä»½å·¥å…·é›†æˆ

ä½¿ç”¨ S3 å…¼å®¹çš„å¤‡ä»½å·¥å…·ï¼ˆå¦‚ rcloneã€duplicatiï¼‰è¿›è¡Œæ–‡ä»¶å¤‡ä»½ï¼š

```bash
# rclone é…ç½®
rclone config
# é€‰æ‹© S3 ç±»å‹
# Endpoint: http://your-domain:8080
# Access Key ID: your-access-key-id
# Secret Access Key: your-secret-key
```

### åœºæ™¯ 2: åº”ç”¨é›†æˆ

åœ¨åº”ç”¨ä¸­ä½¿ç”¨ S3 SDK å­˜å‚¨æ–‡ä»¶ï¼š

```go
// ä¸Šä¼ ç”¨æˆ·å¤´åƒ
_, err := client.FPutObject(ctx, "user-avatars", userID+".jpg", avatarPath, minio.PutObjectOptions{})
```

### åœºæ™¯ 3: é™æ€ç½‘ç«™æ‰˜ç®¡

ç»“åˆ CDN ä½¿ç”¨ S3 å­˜å‚¨é™æ€èµ„æºã€‚

## ğŸ” æ•…éšœæ’æŸ¥

### ç­¾åéªŒè¯å¤±è´¥

```
Error: SignatureDoesNotMatch
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ Access Key å’Œ Secret Key æ˜¯å¦æ­£ç¡®
- ç¡®è®¤æ—¶é—´åŒæ­¥ï¼ˆç­¾åè®¡ç®—ä¾èµ–æ—¶é—´æˆ³ï¼‰
- æŸ¥çœ‹æ—¥å¿—ä¸­çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯

### Bucket å·²å­˜åœ¨

```
Error: BucketAlreadyExists
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- Bucket åç§°åœ¨ç”¨æˆ·ç©ºé—´å†…å¿…é¡»å”¯ä¸€
- ä½¿ç”¨ä¸åŒçš„ Bucket åç§°

### Bucket åç§°ä¸åˆæ³•

```
Error: InvalidBucketName
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ Bucket åç§°æ˜¯å¦ç¬¦åˆ S3 å‘½åè§„èŒƒ
- åªä½¿ç”¨å°å†™å­—æ¯ã€æ•°å­—ã€ç‚¹å’Œè¿å­—ç¬¦
- é•¿åº¦ 3-63 ä¸ªå­—ç¬¦

## ğŸ”— æ¡†æ¶é›†æˆ

### Java æ¡†æ¶é›†æˆ

- [RuoYi-Plus æ¡†æ¶é›†æˆ](/guide/integration-ruoyi) - åœ¨ RuoYi-Vue-Plus æˆ– RuoYi-Cloud-Plus ä¸­ä½¿ç”¨ MyObj S3

### å…¶ä»–é›†æˆæ–¹å¼

MyObj S3 å…¼å®¹æ‰€æœ‰æ”¯æŒ AWS S3 åè®®çš„ SDK å’Œå·¥å…·ï¼ŒåŒ…æ‹¬ï¼š
- AWS SDK (Java, Python, JavaScript, Go, .NET ç­‰)
- MinIO SDK (Go, Java, Python, JavaScript ç­‰)
- rcloneã€s3cmd ç­‰å‘½ä»¤è¡Œå·¥å…·
- å„ç§å¤‡ä»½å·¥å…·ï¼ˆduplicatiã€restic ç­‰ï¼‰

## ğŸ“š æ›´å¤šä¿¡æ¯

- [S3 æœåŠ¡ README](https://github.com/dromara/MyObj/blob/master/src/s3_server/README.md)
- [AWS S3 API æ–‡æ¡£](https://docs.aws.amazon.com/AmazonS3/latest/API/Welcome.html)
- [MinIO Go SDK æ–‡æ¡£](https://min.io/docs/minio/linux/developers/go/API.html)
- [AWS Java SDK æ–‡æ¡£](https://docs.aws.amazon.com/sdk-for-java/latest/developer-guide/home.html)